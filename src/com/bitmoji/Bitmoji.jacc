// JACC Implementation of the Bitmoji Parser

//////////////////////////////////////////
// Directives
//////////////////////////////////////////

%package com.bitmoji
%class Bitmoji
%interface BitmojiTokens
%next yynext()
%get lexer.getToken()
%semantic Object : lexer.getValue()

// Conditionals
%token EQUALS NOT_EQUALS LESS_THAN GREATER_THAN LESS_THAN_OR_EQUAL GREATER_THAN_OR_EQUAL
// Arithmetic Operators
%token ADD SUBTRACT MULTIPLY DIVIDE EXPONENT
// Grouping
%token LEFT_BRACKET RIGHT_BRACKET LEFT_PARENTHESIS RIGHT_PARENTHESIS
// Assignment
%token INTEGER_DECL REAL_DECL STRING_DECL ARRAY_DECL ASSIGN
// Control
%token START_WHILE END_WHILE IF ELIF ELSE START_THEN END_THEN
// Functions
%token FUNCTION_DEF START_FUNCTION_STATEMENTS END_FUNCTION_STATEMENTS RETURN PARAMETER_COMMA
// Literals
%token REAL_LITERAL INT_LITERAL STRING_LITERAL
// IO
%token INPUT OUTPUT
// Other
%token ID START_PROGRAM END_PROGRAM
%left SUBTRACT
%right ASSIGN

%%
//////////////////////////////////////////
// Grammar Rules
//////////////////////////////////////////
program                 : START_PROGRAM stmnt_list END_PROGRAM
                        {
                            program = (BitmojiPT.StatementListNode) $2;
                        }
                        ;

stmnt_list              : stmnt_list statement
                        {
                            ((BitmojiPT.StatementListNode) $1).add((BitmojiPT.StatementNode) $2);
                            $$ = $1;
                        }
			            | statement
			            {
			                $$ = tree.new StatementListNode((BitmojiPT.StatementNode) $1);
			            }
			            ;

statement               : assignment
		                | while_statement
		                | input
		                | output
		                | conditional
		                | function_call
		                | function_def //Does this go in the program NT or does it go outside program NT?
		                ;



ref                     : ID LEFT_BRACKET expr RIGHT_BRACKET
	                    | ID
	                    ;

		   
expr                    : expr ADD term
                        {
                            $$ = tree.new BinaryOperatorNode($1, $3, "+");
                        }
	                    | expr SUBTRACT term
                        {
                            $$ = tree.new BinaryOperatorNode($1, $3, "-");
                        }
	                    | term
	                    ;
	 
term                    : term MULTIPLY factor
                        {
                            $$ = tree.new BinaryOperatorNode($1, $3, "*");
                        }
	                    | term DIVIDE factor
                        {
                            $$ = tree.new BinaryOperatorNode($1, $3, "/");
                        }
	                    | factor
	                    ;
	 
factor                  : factor EXPONENT exp
                        {
                            $$ = tree.new BinaryOperatorNode($1, $3, "**");
                        }
	                    | exp
	                    ;

exp                     : LEFT_PARENTHESIS expr RIGHT_PARENTHESIS
	                    | ref
	                    | function_call
	                    | REAL_LITERAL
	                    {
                            $$ = (Double) $1;
                        }
	                    | INT_LITERAL
	                    {
                            $$ = (Integer) $1;
                        }
	                    ;
	
assignment              : ID ASSIGN expr
                        {
                            $$ = tree.new AssignNode((String) $1, (BitmojiPT.PTNode) $3);
                        }
		                ;

while_statement         : START_WHILE equality stmnt_list END_WHILE
				        ;
				
input                   : INPUT ref
	                    ;

output                  : OUTPUT expr
                        | OUTPUT STRING_LITERAL
	                    ;

conditional             : if_statement
			            | if_statement elif_statement
			            | if_statement else_statement
			            | if_statement elif_statement else_statement
			            ;

if_statement            : IF LEFT_PARENTHESIS equality RIGHT_PARENTHESIS START_THEN stmnt_list END_THEN
			            ;

elif_statement          : ELIF LEFT_PARENTHESIS equality RIGHT_PARENTHESIS START_THEN stmnt_list END_THEN
			            | ELIF LEFT_PARENTHESIS equality RIGHT_PARENTHESIS START_THEN stmnt_list END_THEN elif_statement
			            ;

else_statement          : ELSE START_THEN stmnt_list END_THEN
			            ;

function_call           : ID LEFT_PARENTHESIS ref_list RIGHT_PARENTHESIS
			            ;
			  
ref_list                : ref_list PARAMETER_COMMA ref
		                | ref
		                ;

function_def            : FUNCTION_DEF ID LEFT_PARENTHESIS parameter_list RIGHT_PARENTHESIS START_FUNCTION_STATEMENTS stmnt_list RETURN LEFT_PARENTHESIS expr RIGHT_PARENTHESIS END_FUNCTION_STATEMENTS
			            ;
		   
parameter_list          : parameter_list PARAMETER_COMMA ID
			            | ID
			            ;
			   

equality                : equality EQUALS relational
		                | equality NOT_EQUALS relational
		                | relational
		                ;
		 
relational              : relational GREATER_THAN expr
		                | relational GREATER_THAN_OR_EQUAL expr
		                | relational LESS_THAN expr
		                | relational LESS_THAN_OR_EQUAL expr
		                | expr
		                ;


%%

//////////////////////////////////////////
// Extra Code
//////////////////////////////////////////

    private BitmojiLexer lexer;
    private int token;
    private Object yylvalue;
    private BitmojiPT tree;
    private BitmojiPT.PTNode program;

    public int yynext() {
        lexer.next();
        token = lexer.getToken();
        yylvalue = lexer.getValue();

        return token;
    }

    public void yyerror(String msg) {
        lexer.printError("ERROR: " + msg);
    }

    public Bitmoji(java.io.InputStream in) {
        lexer = new BitmojiLexer(in);
        tree = new BitmojiPT(this);
    }

    public BitmojiPT.PTNode getProgram() {
        return program;
    }

    public static void main(String [] args) {
        String filename="";

        filename = args[0];

        try {
            Bitmoji parser = new Bitmoji(new java.io.FileInputStream(filename));
            parser.yynext();
            parser.parse();

            parser.getProgram().evaluate();

        } catch(java.io.FileNotFoundException e) {
            System.err.println("Could not open file.");
        } catch(java.io.IOException e) {
            System.err.println("File Write Error");
        }
    }